<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Radar Detection Calculator</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f7f7f8; --card:#ffffff; --accent:#2d7dd2; --text:#111; --muted:#666;
      --control-bg:#fff; --control-border:#d0d0d0;
    }
    .dark{
      --bg:#171717; --card:#1f1f1f; --accent:#5aa6ff; --text:#e8eef8; --muted:#aab0bb;
      --control-bg:#1a1a1a; --control-border:#333;
    }

    body{font-family:Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:18px;display:flex;justify-content:center;min-height:100vh}
    #radar-calculator{width:100%;max-width:920px;background:var(--card);box-shadow:0 8px 24px rgba(0,0,0,0.12);border-radius:10px;padding:20px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
    h1{font-size:1.05rem;margin:0}
    .controls{display:flex;gap:8px;align-items:center}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:10px}
    .col{flex:1;min-width:220px}
    label{display:block;font-size:0.85rem;margin-bottom:6px;color:var(--muted)}
    select,button{width:100%;padding:10px;border-radius:8px;border:1px solid var(--control-border);font-size:0.95rem;background:var(--control-bg);color:var(--text)}
    select{appearance:none}
    .btn-primary{background:var(--accent);color:white;border:none;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid var(--control-border)}
    #result{margin-top:12px;padding:12px;border-radius:8px;background:rgba(0,0,0,0.03);border:1px solid rgba(0,0,0,0.04);font-weight:700}
    footer{font-size:0.82rem;color:var(--muted);margin-top:12px}
    .top-actions{display:flex;gap:8px;align-items:center}
    .small{font-size:0.85rem;padding:8px;border-radius:8px}
    @media (max-width:560px){ .row{flex-direction:column} .controls{flex-direction:column-reverse} }
  </style>
</head>
<body>
  <div id="radar-calculator" role="application" aria-label="Radar Detection Calculator">
    <header>
      <div>
        <h1>Radar Detection Calculator</h1>
        <div style="color:var(--muted);font-size:0.88rem">Choose a transmitting plane and a detected plane, then Calculate.</div>
      </div>

      <div class="controls">
        <div class="top-actions">
          <button id="downloadPy" class="small btn-ghost" title="Download the Python/Tkinter source">Download</button>
          <button id="themeToggle" class="small btn-ghost" title="Toggle dark / light">Dark mode</button>
        </div>
      </div>
    </header>

    <div class="row">
      <div class="col">
        <label for="txSelect">Transmitting Plane</label>
        <select id="txSelect"><option value="">Select transmitting plane…</option></select>
      </div>

      <div class="col">
        <label for="rxSelect">Detected Plane</label>
        <select id="rxSelect"><option value="">Select detected plane…</option></select>
      </div>
    </div>

    <div style="display:flex;gap:12px;margin-bottom:6px">
      <button id="calcBtn" class="btn-primary">Calculate</button>
      <button id="resetBtn" class="btn-ghost">Reset</button>
    </div>

    <div id="result" aria-live="polite">Front: -- km / -- NM<br>Side: -- km / -- NM</div>

    <footer>Hosted with GitHub Pages — copy the page URL to share.</footer>
  </div>

  <script>
  // ---------------- FULL DATASET ----------------
  const DATA = [
    {"name":"AN/APG-81","hotRange":550,"coldRange":480,"availablePlane":"F-35A Block 3F","frontRCS":0.00015,"sideRCS":0.0005},
    {"name":"AN/APG-82(V)1","hotRange":320,"coldRange":250,"availablePlane":"F-15E Strike Eagle","frontRCS":16,"sideRCS":12},
    {"name":"AN/APG-63(V)3","hotRange":230,"coldRange":180,"availablePlane":"F-15C Golden Eagle","frontRCS":25,"sideRCS":15},
    {"name":"N007AM Zaslon-AM","hotRange":220,"coldRange":160,"availablePlane":"MiG-31BM Foxhound","frontRCS":15,"sideRCS":25},
    {"name":"KLJ-10","hotRange":190,"coldRange":160,"availablePlane":"J-10C Vigorous Dragon","frontRCS":0.75,"sideRCS":3},
    {"name":"AN/AWG-9","hotRange":180,"coldRange":43,"availablePlane":["F-14A Tomcat","F-14B Tomcat"],"frontRCS":6,"sideRCS":16},
    {"name":"CAPTOR-M","hotRange":180,"coldRange":160,"availablePlane":["EF2000","Eurofighter Typhoon"],"frontRCS":1.2,"sideRCS":75},
    {"name":"N035 Irbis-E","hotRange":180,"coldRange":120,"availablePlane":"Su-35S Flanker-M","frontRCS":10,"sideRCS":22},
    {"name":"RBE2-AA","hotRange":170,"coldRange":130,"availablePlane":"Rafale C F4","frontRCS":0.8,"sideRCS":4},
    {"name":"AN/APG-83","hotRange":170,"coldRange":160,"availablePlane":"F-16CM Block 42+ PoBIT","frontRCS":1.2,"sideRCS":4},
    {"name":"N036","hotRange":160,"coldRange":140,"availablePlane":"Su-57M Felon","frontRCS":0.1,"sideRCS":1.5},
    {"name":"AN/APG-63(V)1","hotRange":160,"coldRange":130,"availablePlane":"F-15J(M) MTDP Eagle","frontRCS":25,"sideRCS":15},
    {"name":["AN/APG-63","AN/APG-63 PSP"],"hotRange":140,"coldRange":120,"availablePlane":["F-15J J-MSIP Eagle","F-15C MSIP II Eagle"],"frontRCS":25,"sideRCS":15},
    {"name":"AN/APG-68(V)9","hotRange":136,"coldRange":119,"availablePlane":"F-16C Block 52+","frontRCS":3,"sideRCS":6},
    {"name":"N010M Zhuk-M","hotRange":117,"coldRange":80,"availablePlane":"MiG-29SMT Fulcrum","frontRCS":4,"sideRCS":8},
    {"name":"RDY-2","hotRange":112,"coldRange":105,"availablePlane":"Mirage 2000-5F","frontRCS":3,"sideRCS":7},
    {"name":"N001VP Mech","hotRange":111,"coldRange":93,"availablePlane":"Su-27SM3 Flanker-J2","frontRCS":15,"sideRCS":22},
    {"name":"AN/APG-73","hotRange":110,"coldRange":90,"availablePlane":"F/A-18C Hornet","frontRCS":5,"sideRCS":8},
    {"name":"J/APG-2","hotRange":110,"coldRange":82,"availablePlane":"F-2A Viper Zero","frontRCS":1.7,"sideRCS":6},
    {"name":"AN/APG-68(V)7","hotRange":105,"coldRange":92,"availablePlane":"F-16CM Block 50","frontRCS":3,"sideRCS":6},
    {"name":["AN/AWG-11","AN/APG-59"],"hotRange":95,"coldRange":6,"availablePlane":["Phantom FG.1","F-4J Phantom II"],"frontRCS":7,"sideRCS":10},
    {"name":"AI.24 Foxhunter","hotRange":94,"coldRange":77,"availablePlane":["Tornado F.3","Tornado F.3 FSP"],"frontRCS":9,"sideRCS":16},
    {"name":"AN/APG-68(V)5","hotRange":92,"coldRange":50,"availablePlane":"F-16CG Block 40","frontRCS":3,"sideRCS":6},
    {"name":["AN/APQ-120","AN/APQ-120(V)5"],"hotRange":83,"coldRange":46,"availablePlane":["F-4E Phantom II","F-4F Phantom II"],"frontRCS":7,"sideRCS":10},
    {"name":"Type 1492","hotRange":79,"coldRange":64,"availablePlane":"J-8F Finback","frontRCS":5,"sideRCS":12},
    {"name":"AN/APG-66J","hotRange":76,"coldRange":60,"availablePlane":"F-4EJ Kai Phantom II","frontRCS":7,"sideRCS":10},
    {"name":"AN/APG-65","hotRange":74,"coldRange":58,"availablePlane":"F/A-18A Hornet","frontRCS":5,"sideRCS":8},
    {"name":"KLJ-3","hotRange":72,"coldRange":62,"availablePlane":"J-10A Vigorous Dragon","frontRCS":2.5,"sideRCS":4},
    {"name":"N001 Mech","hotRange":68,"coldRange":25,"availablePlane":"Su-27P Flanker-B","frontRCS":15,"sideRCS":22},
    {"name":"AN/APG-66A","hotRange":64,"coldRange":59,"availablePlane":"F-16A ADF Block 15","frontRCS":3.2,"sideRCS":6.3},
    {"name":"RDI","hotRange":55,"coldRange":24,"availablePlane":"Mirage 2000-S5","frontRCS":3,"sideRCS":7},
    {"name":"N036Kh","hotRange":50,"coldRange":45,"availablePlane":"Su-57M Felon","frontRCS":0.1,"sideRCS":1.5},
    {"name":"Sapfir-23MLA-II","hotRange":42,"coldRange":30,"availablePlane":"MiG-23MLD","frontRCS":9,"sideRCS":16},
    {"name":"AN/APG-148","hotRange":40,"coldRange":4,"availablePlane":"A-6E Intruder","frontRCS":7,"sideRCS":12},
    {"name":"N036B","hotRange":40,"coldRange":37,"availablePlane":"Su-57M Felon","frontRCS":0.1,"sideRCS":1.5},
    {"name":"N019 Rubin","hotRange":29,"coldRange":17,"availablePlane":"MiG-29 9.12 Fulcrum","frontRCS":4,"sideRCS":8},
    {"name":"Cyrano II","hotRange":23,"coldRange":17,"availablePlane":"Mirage IIIE","frontRCS":7,"sideRCS":11},
    {"name":"J/AWG-12","hotRange":23,"coldRange":17,"availablePlane":"Mitsubishi F-1","frontRCS":7,"sideRCS":10},
    {"name":"AN/APQ-94","hotRange":22,"coldRange":16,"availablePlane":"F-8E Crusader","frontRCS":6,"sideRCS":9},
    {"name":"AI.23","hotRange":19,"coldRange":15,"availablePlane":"Lightning F.6","frontRCS":7,"sideRCS":12},
    {"name":"RP-22","hotRange":18,"coldRange":12,"availablePlane":"MiG-21bis","frontRCS":5,"sideRCS":12},
    {"name":"NASARR F-15A","hotRange":17,"coldRange":14,"availablePlane":"F-104G Starfighter","frontRCS":5,"sideRCS":9},
    {"name":"AN/APQ-159","hotRange":15,"coldRange":8,"availablePlane":"F-5E Tiger II","frontRCS":4,"sideRCS":8},
    {"name":null,"hotRange":0,"coldRange":0,"availablePlane":"Su-25","frontRCS":12,"sideRCS":16},
    {"name":null,"hotRange":0,"coldRange":0,"availablePlane":"MiG-27K","frontRCS":8,"sideRCS":15},
    {"name":null,"hotRange":0,"coldRange":0,"availablePlane":"A-10A Thunderbolt II","frontRCS":12,"sideRCS":16},
    {"name":null,"hotRange":0,"coldRange":0,"availablePlane":"Alpha Jet A","frontRCS":5,"sideRCS":8},
    {"name":null,"hotRange":0,"coldRange":0,"availablePlane":"Zu-57 Felon","frontRCS":1e-7,"sideRCS":1.5e-7}
  ];

  // ---------------- Utility helpers ----------------
  function iterPlanes(entry){
    const p = entry.availablePlane;
    if(Array.isArray(p)) return p.slice();
    return [p];
  }
  function iterRadars(entry){
    const r = entry.name;
    if(Array.isArray(r)) return r.slice();
    return [r];
  }
  function rcsFactor(rcs){ return Math.pow(rcs / 5, 1/4); }
  function rangeKm(base, factor){ return Number((base * factor).toFixed(2)); }
  function kmToNm(km){ return Number((km * 0.539957).toFixed(2)); }

  // Build transmit options: show radar only if plane has multiple radars
  function buildTransmitOptions(data){
    const radarHot = {};
    const planeToRadars = {};

    data.forEach(entry=>{
      const hot = entry.hotRange || 0;
      iterRadars(entry).forEach(r=>{
        if(r == null) return;
        radarHot[r] = Math.max(radarHot[r]||0, hot);
      });
      iterPlanes(entry).forEach(p=>{
        if(p == null) return;
        planeToRadars[p] = planeToRadars[p] || new Set();
        iterRadars(entry).forEach(r=>{
          if(r == null) return;
          planeToRadars[p].add(r);
        });
      });
    });

    const pairs = [];
    Object.keys(planeToRadars).forEach(plane=>{
      const rset = Array.from(planeToRadars[plane]);
      if(rset.length === 0) return;
      if(rset.length === 1){
        pairs.push({label: plane, hot: radarHot[rset[0]]||0});
      } else {
        rset.sort((a,b)=> (radarHot[b]||0) - (radarHot[a]||0));
        rset.forEach(r=>{
          pairs.push({label:`${plane} (${r})`, hot: radarHot[r]||0});
        });
      }
    });

    pairs.sort((a,b)=> b.hot - a.hot);
    return pairs.map(p=>p.label);
  }

  function buildDetectOptions(data){
    const planeBestFront = {};
    data.forEach(entry=>{
      const front = (entry.frontRCS || 0);
      iterPlanes(entry).forEach(p=>{
        if(p == null) return;
        planeBestFront[p] = Math.max(planeBestFront[p]||-1, front);
      });
    });
    return Object.entries(planeBestFront).sort((a,b)=> b[1]-a[1]).map(kv=>kv[0]);
  }

  const txSelect = document.getElementById("txSelect");
  const rxSelect = document.getElementById("rxSelect");
  const resultDiv = document.getElementById("result");

  function populate(){
    txSelect.length = 1; rxSelect.length = 1;
    buildTransmitOptions(DATA).forEach(opt=>{
      const o = document.createElement("option"); o.value = opt; o.textContent = opt; txSelect.appendChild(o);
    });
    buildDetectOptions(DATA).forEach(opt=>{
      const o = document.createElement("option"); o.value = opt; o.textContent = opt; rxSelect.appendChild(o);
    });
  }

  function parseTxLabel(label){
    if(!label) return [null,null];
    const idx = label.lastIndexOf(" (");
    if(idx !== -1 && label.endsWith(")")){
      return [label.substring(0, idx).trim(), label.substring(idx+2, label.length-1).trim()];
    }
    return [label.trim(), null];
  }

  function findTxEntry(plane, radar){
    if(!plane) return null;
    if(radar){
      for(const e of DATA){
        const names = iterRadars(e).filter(x=>x!=null);
        if(names.length === 0) continue;
        for(const p of iterPlanes(e)){
          if(p === plane && names.includes(radar)) return e;
        }
      }
      return null;
    }
    let candidate = null, bestHot = -1;
    for(const e of DATA){
      if(e.name == null) continue;
      for(const p of iterPlanes(e)){
        if(p === plane){
          const hot = e.hotRange || 0;
          if(hot > bestHot){ bestHot = hot; candidate = e; }
        }
      }
    }
    return candidate;
  }

  function findRxEntry(plane){
    if(!plane) return null;
    let candidate = null, bestFront = -1;
    for(const e of DATA){
      for(const p of iterPlanes(e)){
        if(p === plane){
          const front = e.frontRCS || 0;
          if(front > bestFront){ bestFront = front; candidate = e; }
        }
      }
    }
    return candidate;
  }

  function calculate(){
    const [plane,radar] = parseTxLabel(txSelect.value);
    const tx = findTxEntry(plane,radar);
    const rx = findRxEntry(rxSelect.value);

    if(!tx || !rx){ resultDiv.innerHTML="Front: N/A<br>Side: N/A"; return; }
    const hotRange = tx.hotRange||0;
    const front = rx.frontRCS||0, side = rx.sideRCS||0;
    if(hotRange===0||front===0||side===0){ resultDiv.innerHTML="Front: N/A<br>Side: N/A"; return; }
    const fk = rangeKm(hotRange, rcsFactor(front));
    const sk = rangeKm(hotRange, rcsFactor(side));
    const fn = kmToNm(fk), sn = kmToNm(sk);
    resultDiv.innerHTML=`Front: ${fk} km / ${fn} NM<br>Side: ${sk} km / ${sn} NM`;
  }

  document.getElementById("calcBtn").addEventListener("click", calculate);
  document.getElementById("resetBtn").addEventListener("click", ()=>{
    txSelect.selectedIndex=0; rxSelect.selectedIndex=0;
    resultDiv.innerHTML="Front: -- km / -- NM<br>Side: -- km / -- NM";
  });

  // Theme toggle
  document.getElementById("themeToggle").addEventListener("click",()=>{
    document.body.classList.toggle("dark");
  });

  // ---------------- Download Python Source (safe conversion) ----------------
  function jsToPython(obj){
    // stringify then convert JS null/true/false to Python None/True/False
    return JSON.stringify(obj, null, 4)
      .replace(/\bnull\b/g, "None")
      .replace(/\btrue\b/g, "True")
      .replace(/\bfalse\b/g, "False");
  }

  const pySource = `
# radar_calculator_gui.pyw
import tkinter as tk
from math import pow

# ---------------------- DATA ----------------------
DATA = ${jsToPython(DATA)}

# ---------------------- Appearance & helpers ----------------------
FONT = ("Segoe UI", 12)

DARK = {
    "bg": "#1e1e1e",
    "fg": "#ffffff",
    "button_bg": "#2f2f2f",
    "button_fg": "#ffffff",
    "listbox_bg": "#252525",
    "listbox_fg": "#ffffff",
    "active_bg": "#444444"
}
LIGHT = {
    "bg": "#ffffff",
    "fg": "#000000",
    "button_bg": "#f0f0f0",
    "button_fg": "#000000",
    "listbox_bg": "#ffffff",
    "listbox_fg": "#000000",
    "active_bg": "#d0d0d0"
}

def rcs_factor(rcs):
    return pow(rcs / 5, 1/4)

def range_km(base_range, factor):
    return round(base_range * factor, 2)

def km_to_nm(km):
    return round(km * 0.539957, 2)

def iter_planes(entry):
    p = entry.get("availablePlane")
    if isinstance(p, list):
        for x in p:
            yield x
    else:
        yield p

def iter_radars(entry):
    r = entry.get("name")
    if isinstance(r, list):
        for x in r:
            yield x
    else:
        yield r

# ---------------------- Build option lists ----------------------
def build_transmit_options(data):
    radar_hot = {}
    plane_to_radars = {}
    for entry in data:
        hot = entry.get("hotRange", 0) or 0
        for r in iter_radars(entry):
            if r is None: continue
            radar_hot[r] = max(radar_hot.get(r, 0), hot)
        for p in iter_planes(entry):
            if p is None: continue
            plane_to_radars.setdefault(p, set())
            for r in iter_radars(entry):
                if r is None: continue
                plane_to_radars[p].add(r)
    pairs = []
    for plane, rset in plane_to_radars.items():
        if not rset: continue
        if len(rset) == 1:
            r = next(iter(rset))
            pairs.append((plane, radar_hot.get(r, 0)))
        else:
            for r in sorted(rset, key=lambda x: -radar_hot.get(x, 0)):
                pairs.append((f"{plane} ({r})", radar_hot.get(r, 0)))
    pairs.sort(key=lambda kv: -kv[1])
    return [label for label, _ in pairs]

def build_detect_options(data):
    plane_best_front = {}
    for entry in data:
        front = entry.get("frontRCS", 0) or 0
        for p in iter_planes(entry):
            if p is None: continue
            plane_best_front[p] = max(plane_best_front.get(p, -1), front)
    return [p for p, _ in sorted(plane_best_front.items(), key=lambda kv: -kv[1])]

# ---------------------- Scrollable dropdown ----------------------
class ScrollableDropdown(tk.Frame):
    open_instance = None
    _just_closed = False

    def __init__(self, parent, title, options, callback, theme, height=9, width_chars=40):
        super().__init__(parent, bg=theme["bg"])
        self.title_label = tk.Label(self, text=title, bg=theme["bg"], fg=theme["fg"], font=FONT)
        self.title_label.pack(pady=(0, 4))

        self.var = tk.StringVar(value="Select...")
        self.button = tk.Button(self, textvariable=self.var, anchor="w",
                                width=width_chars,
                                bg=theme["button_bg"], fg=theme["button_fg"],
                                activebackground=theme["active_bg"], font=FONT)
        self.button.pack(fill="x")
        self.button.bind("<ButtonRelease-1>", self._on_release)

        self.options = list(options)
        self.callback = callback
        self.theme = theme
        self.height = height

        self.top = None
        self.listbox = None

    def _on_release(self, event):
        if ScrollableDropdown._just_closed:
            return
        self.toggle()

    def toggle(self):
        if ScrollableDropdown.open_instance and ScrollableDropdown.open_instance is not self:
            ScrollableDropdown.open_instance.close()
        if self.top:
            self.close()
        else:
            self.open()

    def open(self):
        if self.top: return
        ScrollableDropdown.open_instance = self
        self.top = tk.Toplevel(self)
        self.top.overrideredirect(True)
        self.top.configure(bg=self.theme["bg"])
        x = self.button.winfo_rootx()
        y = self.button.winfo_rooty() + self.button.winfo_height()
        w = max(self.button.winfo_width(), 200)
        h = min(self.height * 22, 400)
        self.top.geometry(f"{w}x{h}+{x}+{y}")
        frame = tk.Frame(self.top, bg=self.theme["bg"])
        frame.pack(fill="both", expand=True)
        self.listbox = tk.Listbox(frame, height=self.height,
                                  bg=self.theme["listbox_bg"], fg=self.theme["listbox_fg"],
                                  selectbackground=self.theme["active_bg"], activestyle="none",
                                  exportselection=False, font=FONT)
        scrollbar = tk.Scrollbar(frame, command=self.listbox.yview)
        self.listbox.configure(yscrollcommand=scrollbar.set)
        self.listbox.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")
        for opt in self.options:
            self.listbox.insert("end", opt)
        self.listbox.bind("<<ListboxSelect>>", self._on_select)
        self.listbox.bind("<MouseWheel>", self._on_mousewheel)
        self.listbox.bind("<Button-4>", lambda e: self.listbox.yview_scroll(-1, "units"))
        self.listbox.bind("<Button-5>", lambda e: self.listbox.yview_scroll(1, "units"))
        self.top.bind("<FocusOut>", lambda e: self.close())
        try:
            self.top.focus_force()
        except Exception:
            pass

    def _on_mousewheel(self, event):
        if self.listbox:
            try:
                delta = int(event.delta / 120)
            except Exception:
                delta = 0
            if delta:
                self.listbox.yview_scroll(-delta, "units")

    def _on_select(self, event):
        sel = self.listbox.curselection()
        if not sel:
            return
        val = self.listbox.get(sel[0])
        self.var.set(val)
        if callable(self.callback):
            self.callback(val)
        self.close()

    def close(self):
        if self.top:
            try:
                self.top.destroy()
            except Exception:
                pass
        self.top = None
        self.listbox = None
        if ScrollableDropdown.open_instance is self:
            ScrollableDropdown.open_instance = None
        ScrollableDropdown._just_closed = True
        self.after(150, lambda: setattr(ScrollableDropdown, "_just_closed", False))

    def update_theme(self, theme):
        self.theme = theme
        self.config(bg=theme["bg"])
        self.title_label.config(bg=theme["bg"], fg=theme["fg"])
        self.button.config(bg=theme["button_bg"], fg=theme["button_fg"], activebackground=theme["active_bg"])
        if self.listbox:
            self.listbox.config(bg=theme["listbox_bg"], fg=theme["listbox_fg"], selectbackground=theme["active_bg"])
        if self.top:
            self.top.config(bg=theme["bg"])

# ---------------------- Main app ----------------------
class RadarCalApp(tk.Tk):
    def __init__(self, data):
        super().__init__()
        self.data = data
        self.theme = DARK
        self.title("Radar Detection Calculator")
        self.geometry("300x320")
        self.minsize(200, 350)
        self.resizable(True, True)
        self.configure(bg=self.theme["bg"])

        self.tx_options = build_transmit_options(self.data)
        self.rx_options = build_detect_options(self.data)

        self.tx_dd = ScrollableDropdown(self, "Transmitting Plane", self.tx_options, self.on_tx_selected, self.theme)
        self.tx_dd.pack(fill="x", padx=20, pady=(12, 8))

        self.rx_dd = ScrollableDropdown(self, "Detected Plane", self.rx_options, self.on_rx_selected, self.theme)
        self.rx_dd.pack(fill="x", padx=20, pady=(0, 8))

        self.calc_btn = tk.Button(self, text="Calculate", command=self.calculate,
                                  bg=self.theme["button_bg"], fg=self.theme["button_fg"], font=FONT)
        self.calc_btn.pack(pady=(6, 12))

        self.result_label = tk.Label(self, text="Front: -- km / -- NM\\nSide:  -- km / -- NM",
                                     bg=self.theme["bg"], fg=self.theme["fg"], font=FONT, justify="center")
        self.result_label.pack(pady=6)

        self.toggle_btn = tk.Button(self, text="Switch to Light Mode", command=self.toggle_theme,
                                    bg=self.theme["button_bg"], fg=self.theme["button_fg"], font=FONT)
        self.toggle_btn.pack(pady=(6, 12))

        self.tx_selection = None
        self.rx_selection = None

    def on_tx_selected(self, val):
        self.tx_selection = val

    def on_rx_selected(self, val):
        self.rx_selection = val

    def _parse_tx_label(self, label):
        if not label:
            return None, None
        if " (" in label and label.endswith(")"):
            plane = label.split(" (", 1)[0].strip()
            radar = label.split(" (", 1)[1][:-1].strip()
            return plane, radar
        return label, None

    def _find_tx_entry(self, plane, radar):
        if not plane:
            return None
        if radar:
            for entry in self.data:
                names = [n for n in iter_radars(entry) if n is not None]
                if not names:
                    continue
                for p in iter_planes(entry):
                    if p == plane and radar in names:
                        return entry
            return None
        candidate = None
        best_hot = -1
        for entry in self.data:
            if entry.get("name") is None:
                continue
            for p in iter_planes(entry):
                if p == plane:
                    hot = entry.get("hotRange", 0) or 0
                    if hot > best_hot:
                        best_hot = hot
                        candidate = entry
        return candidate

    def _find_rx_entry(self, plane):
        if not plane:
            return None
        candidate = None
        best_front = -1
        for entry in self.data:
            for p in iter_planes(entry):
                if p == plane:
                    front = entry.get("frontRCS", 0) or 0
                    if front > best_front:
                        best_front = front
                        candidate = entry
        return candidate

    def calculate(self):
        if not self.tx_selection or not self.rx_selection:
            self.result_label.config(text="Front: -- km / -- NM\\nSide:  -- km / -- NM")
            return

        plane, radar = self._parse_tx_label(self.tx_selection)
        tx_entry = self._find_tx_entry(plane, radar)
        rx_entry = self._find_rx_entry(self.rx_selection)

        if not tx_entry or not rx_entry:
            self.result_label.config(text="Front: N/A\\nSide: N/A")
            return

        hotRange = tx_entry.get("hotRange", 0) or 0
        front_rcs = rx_entry.get("frontRCS", 0) or 0
        side_rcs = rx_entry.get("sideRCS", 0) or 0

        if hotRange == 0 or front_rcs == 0 or side_rcs == 0:
            self.result_label.config(text="Front: N/A\\nSide: N/A")
            return

        front_factor = rcs_factor(front_rcs)
        side_factor = rcs_factor(side_rcs)

        front_km = range_km(hotRange, front_factor)
        side_km = range_km(hotRange, side_factor)
        front_nm = km_to_nm(front_km)
        side_nm = km_to_nm(side_km)

        self.result_label.config(text=f"Front: {front_km} km / {front_nm} NM\\nSide:  {side_km} km / {side_nm} NM")

    def toggle_theme(self):
        if self.theme is DARK:
            self.theme = LIGHT
            self.toggle_btn.config(text="Switch to Dark Mode")
        else:
            self.theme = DARK
            self.toggle_btn.config(text="Switch to Light Mode")

        self.configure(bg=self.theme["bg"])
        self.tx_dd.update_theme(self.theme)
        self.rx_dd.update_theme(self.theme)
        self.calc_btn.config(bg=self.theme["button_bg"], fg=self.theme["button_fg"], activebackground=self.theme["active_bg"])
        self.toggle_btn.config(bg=self.theme["button_bg"], fg=self.theme["button_fg"], activebackground=self.theme["active_bg"])
        self.result_label.config(bg=self.theme["bg"], fg=self.theme["fg"])

if __name__ == "__main__":
    app = RadarCalApp(DATA)
    app.mainloop()
`;

  document.getElementById("downloadPy").addEventListener("click",()=>{
    const blob = new Blob([pySource], {type: "text/x-python;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = "radar_calculator_gui.pyw";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=> URL.revokeObjectURL(url), 2000);
  });

  // init
  populate();
  </script>
</body>
</html>
